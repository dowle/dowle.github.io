---
title: "PHP错误处理"
date: 2020-08-12T14:59:16+08:00
tags: ["PHP"]
categories: ["PHP"]
draft: false
---
## 错误说明
在 PHP 中，默认的错误处理很简单。一条错误消息会被发送到浏览器，这条消息带有文件名、行号以及描述错误的消息。  

错误相关的配置:  

| 配置项 | <img width="100"/>默认值 | 说明 |
| :------   | :-----   | :---  |
| error_reporting | null | 设置 PHP 的报错级别并返回当前级别(数字或常量)。|
| display_errors | 1 | 该选项设置是否将错误信息作为输出的一部分显示到屏幕，或者对用户隐藏而不显示。<br/>*注意: 该特性不要在上线生产环境中使用 (在开发测试过程中使用)* |
| log_errors | 0 | 设置是否将脚本运行的错误信息记录到服务器错误日志或者error_log之中 |
| error_log | null | 设置脚本错误将被记录到的文件 |

一般生产环境的配置为： 
```ini
; 关闭错误显示，打开错误日志
display_errors=Off
log_errors=On
error_log="/var/log/php/php.log"
```

错误相关的函数： 

| 函数名 | 说明 |
| :-------  | :--- |
|error_reporting | 指定错误报告级别，其中-1表示显示所有错误，0表示关闭错误，无参数表示获取当前的错误级别，其他参数表示设置具体的错误级别 |  
|set_error_handler | 注册错误的处理器 |
|set_exception_handler | 注册异常的处理器 |
|register_shutdown_function | 注册一个会在PHP中止时执行的函数，包括正常中止、exit中止、致命错误中止 |

## 实际使用例子
*下面的代码主要来自于lumen*  
```php

// 定义一个注册错误的trait类
trait RegistersExceptionHandlers
{
    /**
     * 设置错误handler
     *
     * @return void
     */
    protected function registerErrorHandling()
    {
        // 报告所有错误
        error_reporting(-1);

        // 注册错误处理
        set_error_handler(function ($level, $message, $file = '', $line = 0) {
            // 抛出错误异常
            throw new ErrorException($message, 0, $level, $file, $line);
        });

        // 注册异常处理
        set_exception_handler(function ($e) {
            // 这里是一个统一的异常handler -- 需要实现，主要包括记录日志、异常时返回等
            $handler = (object)[];
            $handler->report($e);
        });

        // 注册中止处理函数
        register_shutdown_function(function () {
            // 主要捕获错误
            if ( ! is_null($error = error_get_last())) {
                // 抛出错误异常
                throw new ErrorException($error['message'], 0, $error['type'],
                    $error['file'], $error['line']);
            }
        });
    }
}
```
