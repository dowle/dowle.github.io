---
title: "搭建Mysql主从集群"
date: 2020-08-10T14:45:57+08:00
tags: ["数据库", "数据库集群", "MySQL"]
categories: ["数据库"]
draft: false
---
## Mysql主从的作用
1. 数据热备：作为后备数据库。在主库出现故障后，能够切换成为主库，继续提供服务。
2. 架构扩展：业务越来越大，数据的io、网络等压力越来越大，主从架构可以分散数据库读的压力。
3. 读写分离：使数据库支持更大的并发，同时对于后台的查询与分析业务，可以走从库，防止阻塞用户侧读写。

## 搭建Mysql主从集群
**本文使用docker搭建，仅用于开发测试**  
### 启动mysql示例
搭建1主2从的集群，其中3001对应主库，3002、3003对应从库  
编辑配置文件
```ini
dowle@dowle-pc:/data/docker/mysql-cluster$ cat 3001.cnf 
[mysqld]
log-bin=mysql-bin
server-id=3001

dowle@dowle-pc:/data/docker/mysql-cluster$ cat 3002.cnf 
[mysqld]
log-bin=mysql-bin
server-id=3002

dowle@dowle-pc:/data/docker/mysql-cluster$ cat 3003.cnf 
[mysqld]
log-bin=mysql-bin
server-id=3003
```

启动实例  
```bash
docker run -d --name 3001 -v $(pwd)/3001.cnf:/etc/mysql/conf.d/cluster.cnf -p 3001:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql

docker run -d --name 3002 -v $(pwd)/3002.cnf:/etc/mysql/conf.d/cluster.cnf -p 3002:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql

docker run -d --name 3003 -v $(pwd)/3003.cnf:/etc/mysql/conf.d/cluster.cnf -p 3003:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql
```

测试  
在navicat上连接3个mysql实例检查是否可用。用户: root   密码: 123456  

### 创建主库复制账号
```sql
create user "slave"@"%" identified by "slave";
grant ALL privileges on *.* TO 'slave'@'%';
flush privileges;
```

注：mysql8必须创建用户与授权分开。  

### 配置主从
1. 主库操作  
```bash
# 查看主库在docker集群内的ip
docker inspect 3001 | grep "IP"
# 进入主库实例
docker exec -it 3001 /bin/bash
# 进入sql-cli
mysql -p123456
# 查看master状态
show master status;
```
2. 从库操作  
```bash
# 进入从库实例
docker exec -it 3002 /bin/bash
# 进入sql-cli
mysql -p123456
# 暂停slave
stop slave;
# 配置主库信息 - 这里的ip为master为docker内ip
change master to master_host="172.17.0.2",master_user="slave",master_password="slave",master_log_file="mysql-bin.000003",master_log_pos=856;
# 开启slave
start slave;
# 查看同步状态: Slave_IO_Running、Slave_SQL_Running 是否为Yes，若不是则查看错误信息。Seconds_Behind_Master 表示落后主库的时间
show slave status \G;

# 重复操作，添加3003从库
```
3. 检查结果  
在主库添加数据，看从库是否有对应的数据。  

## 主从延时
因为mysql的复制默认是异步复制，所以主从的数据会存在一定的不一致的时间窗口。虽然mysql也提供了同步复制与半同步复制及PXC架构(多主强一致)，但是性能不佳，高并发项目不建议使用。 
提高集群内网络情况、从库的性能及并行复制可以减少不一致的时间窗口。

业务解决思路：
1. 产品上允许一定时间的不一致
2. 某些业务强制读主
3. 通过设置标志去读主，在通过监听bin-log日志来删除该标志，也可以设置一个自动过期的标志。